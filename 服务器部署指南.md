# 服务器部署完整指南

## 📦 项目组成说明

### Nginx来源解释
**nginx不需要在服务器上单独安装！** 它来自于Docker镜像：

1. **前端Dockerfile中的配置：**
   ```dockerfile
   # 生产阶段
   FROM nginx:alpine  # ← nginx来源：官方Docker镜像
   ```

2. **工作原理：**
   - Docker构建时会自动下载 `nginx:alpine` 镜像
   - 该镜像已经包含完整的nginx web服务器
   - 我们只需要提供配置文件 `nginx.conf`

### 项目架构
```
项目部署架构：
├── 前端容器 (nginx:alpine)
│   ├── Vue.js构建产物 (/usr/share/nginx/html)
│   ├── nginx.conf (配置文件)
│   └── 端口映射: 主机80 → 容器80
├── 后端容器 (python:3.11-slim)
│   ├── FastAPI应用
│   └── 端口映射: 主机8000 → 容器8000
└── Docker网络 (容器间通信)
```

## 🚀 服务器部署步骤

### 第一步：准备服务器环境

#### 1.1 安装Docker
```bash
# CentOS/RHEL
sudo yum install -y docker docker-compose

# Ubuntu/Debian
sudo apt update
sudo apt install -y docker.io docker-compose

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker

# 验证安装
docker --version
docker-compose --version
```

#### 1.2 配置Docker权限（可选）
```bash
# 将用户添加到docker组，避免每次使用sudo
sudo usermod -aG docker $USER
# 重新登录生效
```

### 第二步：上传项目到服务器

#### 方法1：使用Git（推荐）
```bash
# 在服务器上克隆项目
git clone <你的项目仓库地址>
cd email
```

#### 方法2：使用SCP上传
```bash
# 在本地电脑上执行，将整个项目文件夹上传
scp -r /path/to/email username@server_ip:/home/username/
```

#### 方法3：使用FTP工具
- 使用FileZilla、WinSCP等工具
- 将整个 `email` 文件夹上传到服务器

### 第三步：在服务器上部署

#### 3.1 进入项目目录
```bash
cd /path/to/email  # 进入上传的项目目录
```

#### 3.2 检查项目结构
```bash
ls -la
# 应该看到以下文件：
# - docker-compose.yml
# - email/ (前端文件夹)
# - email-api/ (后端文件夹)
# - deploy.sh
# - 其他配置文件
```

#### 3.3 启动服务
```bash
# 方法1：使用docker-compose直接启动
docker-compose up -d

# 方法2：使用部署脚本
chmod +x deploy.sh
./deploy.sh
```

#### 3.4 验证部署
```bash
# 检查容器状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 检查端口监听
netstat -tulnp | grep -E ":(80|8000)"
```

### 第四步：配置服务器访问

#### 4.1 开放防火墙端口
```bash
# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=8000/tcp
sudo firewall-cmd --reload

# Ubuntu (ufw)
sudo ufw allow 80
sudo ufw allow 8000

# 或者只开放80端口（推荐）
sudo ufw allow 80
```

#### 4.2 获取服务器IP
```bash
# 查看服务器公网IP
curl ifconfig.me
# 或
ip addr show
```

## 🌐 访问项目

### 部署成功后访问地址：
- **前端应用**: `http://服务器IP`
- **后端API**: `http://服务器IP:8000/api/mail`

### 示例：
如果服务器IP是 `123.456.789.0`：
- 前端：`http://123.456.789.0`
- 后端：`http://123.456.789.0:8000`

## 🔧 常见问题解决

### 1. 端口被占用
```bash
# 检查端口占用
sudo netstat -tulnp | grep :80

# 解决方案：修改docker-compose.yml中的端口映射
# 例如：将 "80:80" 改为 "8080:80"
```

### 2. Docker权限问题
```bash
# 如果出现权限错误，使用sudo
sudo docker-compose up -d
```

### 3. 无法访问
检查顺序：
1. 容器是否正常运行：`docker-compose ps`
2. 防火墙是否开放端口
3. 云服务器安全组是否配置
4. 网络连接是否正常

### 4. API无法连接
- 检查后端容器日志：`docker-compose logs backend`
- 确认DeepSeek API密钥有效
- 检查服务器网络能否访问外部API

## 📝 生产环境优化

### 1. 使用域名
```bash
# 购买域名并解析到服务器IP
# 修改nginx.conf中的server_name
```

### 2. 配置SSL证书
```bash
# 使用Let's Encrypt免费证书
sudo apt install certbot
sudo certbot --nginx -d yourdomain.com
```

### 3. 设置自动重启
```bash
# 服务器重启后自动启动容器
# docker-compose.yml中已配置 restart: unless-stopped
```

### 4. 数据备份
```bash
# 定期备份项目配置和数据
tar -czf email-backup-$(date +%Y%m%d).tar.gz /path/to/email
```

## 🎯 快速部署命令总结

```bash
# 1. 上传项目到服务器后
cd /path/to/email

# 2. 一键部署
chmod +x deploy.sh && ./deploy.sh

# 3. 检查状态
docker-compose ps

# 4. 访问应用
echo "访问 http://$(curl -s ifconfig.me)"
``` 